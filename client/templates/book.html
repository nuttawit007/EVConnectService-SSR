{% extends 'base.html' %}

{% block content %}
<!-- Main Content -->
<main class="px-8 py-12 max-w-7xl mx-auto">
    <!-- Page Title -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-3">Book an Appointment</h1>
        <p class="text-slate-400">Appointment your EV service in minutes</p>
    </div>

    <form method="POST" action="{% url 'book' %}">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Choose Vehicle & Add Vehicle -->
        <div class="grid md:grid-cols-2 gap-8 mb-10">
            <!-- Choose Vehicle -->
            <div class="flex gap-6">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Choose Vehicle <span class="text-yellow-400">*</span></h2>
                    <p class="text-slate-400 mb-4">Choose your EV vehicle</p>
                </div>
                <div>
                    <select name="vehicle" class="px-4 py-4 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 focus:outline-none focus:border-yellow-400 transition-colors">
                        <option value="">choose your EV vehicle</option>
                        {% for vehicle in form.fields.vehicle.queryset %}
                            <option value="{{ vehicle.id }}" {% if default_vehicle and vehicle.id|stringformat:"s" == default_vehicle|stringformat:"s" %}selected{% endif %}>{{ vehicle.license_plate }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="text-red-400 text-sm mt-2">
                    {{ form.vehicle.errors }}
                </div>
            </div>

            <!-- Add Vehicle -->
            <div class="flex gap-6">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Add Vehicle (optional)</h2>
                    <p class="text-slate-400 mb-4">if you don't have EV vehicle</p>
                </div>
                <a href="{% url 'add_vehicle' %}">
                    <button type="button" class="px-6 py-3 border-2 border-slate-400 text-white rounded-xl font-medium hover:bg-slate-800 transition-colors">
                        Add new vehicle
                    </button>
                </a>
            </div>
        </div>

        <div class="flex justify-between gap-12 mb-10">
            <!-- Choose Service -->
            <div class="flex-1">
                <h2 class="text-2xl font-semibold mb-2">Choose Service  <span class="text-yellow-400">*</span></h2>
                <p class="text-slate-400 mb-6">Choose the service you need</p>
                <div class="grid md:grid-cols-2 gap-4">
                    {% for service in form.fields.service_types.queryset %}
                        <label class="relative cursor-pointer group">
                            <input type="checkbox" name="service_types" value="{{ service.id }}" class="peer sr-only" {% if default_services and service.id|stringformat:"s" in default_services %}checked{% endif %}>
                            <div class="p-6 bg-slate-800 border-2 border-slate-700 rounded-xl peer-checked:border-yellow-400 transition-colors">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="w-5 h-5 flex items-center justify-center border-2 rounded border-slate-500 bg-slate-900 transition-all peer-checked:border-yellow-400">
                                    </span>
                                    <h3 class="font-semibold">{{ service.name }}</h3>
                                </div>
                                <p class="text-sm text-yellow-400">{{ service.description }}</p>
                            </div>
                        </label>
                    {% endfor %}
                </div>
                <div class="text-red-400 text-sm mt-2">
                    {{ form.service_types.errors }}
                </div>
            </div>
    
            <!-- Description -->
            <div class="flex-1">
                <h2 class="text-2xl font-semibold mb-2">Description</h2>
                <p class="text-slate-400 mb-4">Add notes or special requests for your appointment.</p>
                {{ form.description }}
                <div class="text-red-400 text-sm mt-2">
                    {{ form.description.errors }}
                </div>
            </div>
        </div>

        <!-- Date and Time -->
        <div class="mb-12">
            <h2 class="text-2xl font-semibold mb-2">Choose Date and Time  <span class="text-yellow-400">*</span></h2>
            <p class="text-slate-400 mb-6">Select date and time you need.</p>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Calendar -->
                <div class="bg-slate-800 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prevMonth" type="button" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        </button>
                        <h3 id="monthYear" class="text-center font-semibold"></h3>
                        <button id="nextMonth" type="button" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        </button>
                    </div>
                    
                    <!-- Days of Week -->
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center text-sm text-slate-400 py-2">Sun</div>
                        <div class="text-center text-sm text-slate-400 py-2">Mon</div>
                        <div class="text-center text-sm text-slate-400 py-2">Tue</div>
                        <div class="text-center text-sm text-slate-400 py-2">Wed</div>
                        <div class="text-center text-sm text-slate-400 py-2">Thu</div>
                        <div class="text-center text-sm text-slate-400 py-2">Fri</div>
                        <div class="text-center text-sm text-slate-400 py-2">Sat</div>
                    </div>

                    <!-- Calendar Days -->
                    <div id="calendarDays" class="grid grid-cols-7 gap-2">
                        <!-- Days will be generated by JavaScript -->
                    </div>
                    <input type="hidden" name="date" id="selectedDateInput" value="">
                    <div class="text-red-400 text-sm mt-2">
                        {{ form.date.errors }}
                    </div>
                </div>

                <!-- Time Slots -->
                <div class="bg-slate-800 rounded-xl p-6">
                    <h3 id="selectedDate" class="text-center font-semibold mb-6">Select a date</h3>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Morning -->
                        <div>
                            <h4 class="font-semibold mb-4">Morning</h4>
                            <div class="flex flex-col gap-4">
                                {% for time in times_morning %}
                                <label class="relative cursor-pointer time-label">
                                    <input type="radio" name="time" value="{{ time }}" class="peer sr-only time-radio">
                                    <div class="px-4 py-2.5 bg-slate-800 border-2 border-slate-700 rounded-lg peer-checked:border-yellow-400 transition-colors flex items-center gap-3">
                                        <div class="w-5 h-5 rounded-full border-2 border-slate-500 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 flex items-center justify-center transition-colors">
                                            <div class="w-2.5 h-2.5 bg-slate-900 rounded-full"></div>
                                        </div>
                                        <span>{{ time }}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Afternoon -->
                        <div>
                            <h4 class="font-semibold mb-4">Afternoon</h4>
                            <div class="flex flex-col gap-4">
                                {% for time in times_afternoon %}
                                <label class="relative cursor-pointer time-label">
                                    <input type="radio" name="time" value="{{ time }}" class="peer sr-only time-radio">
                                    <div class="px-4 py-2.5 bg-slate-800 border-2 border-slate-700 rounded-lg peer-checked:border-yellow-400 transition-colors flex items-center gap-3">
                                        <div class="w-5 h-5 rounded-full border-2 border-slate-500 peer-checked:border-yellow-400 peer-checked:bg-yellow-400 flex items-center justify-center transition-colors">
                                            <div class="w-2.5 h-2.5 bg-slate-900 rounded-full"></div>
                                        </div>
                                        <span>{{ time }}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="text-red-400 text-sm mt-2">
                        {{ form.time.errors }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirm Button -->
        <div class="flex justify-end">
            <button type="submit" class="px-8 py-3 bg-yellow-400 text-slate-900 rounded-lg font-semibold hover:bg-yellow-500 transition-colors">
                confirm booking
            </button>
        </div>
    </form>
</main>

<!-- Added JavaScript for dynamic calendar functionality -->
<script>
    let currentDate = new Date();
    let selectedDate = new Date();

    const monthNames = ["January", "February", "March", "April", "May", "June", 
        "July", "August", "September", "October", "November", "December"];

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';

        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('button');
            emptyDay.className = 'py-2 text-center';
            calendarDays.appendChild(emptyDay);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayButton = document.createElement('button');
            const dateToCheck = new Date(year, month, day);
            dateToCheck.setHours(0, 0, 0, 0);

            const isSelected = selectedDate.getDate() === day && 
                                selectedDate.getMonth() === month && 
                                selectedDate.getFullYear() === year;

            const isPast = dateToCheck < today;

            if (isPast) {
                dayButton.className = 'py-2 text-center text-slate-600 cursor-not-allowed rounded-lg';
                dayButton.disabled = true;
            } else if (isSelected) {
                dayButton.className = 'py-2 text-center bg-yellow-400 text-slate-900 font-semibold rounded-lg';
            } else {
                dayButton.className = 'py-2 text-center hover:bg-slate-700 rounded-lg transition-colors';
            }

            dayButton.textContent = day;

            if (!isPast) {
                dayButton.addEventListener('click', () => {
                    selectedDate = new Date(year, month, day);
                    renderCalendar();
                    updateSelectedDateDisplay();
                    updateTimeSlots();
                });
            }

            calendarDays.appendChild(dayButton);
        }
    }

    function unselectTimeRadios() {
        document.querySelectorAll('input[name="time"]').forEach(input => {
            input.checked = false;
        });
    }

    function updateSelectedDateDisplay() {
        const day = selectedDate.getDate();
        const month = monthNames[selectedDate.getMonth()];
        const year = selectedDate.getFullYear();
        document.getElementById('selectedDate').textContent = `${day} ${month} ${year}`;
        document.getElementById('selectedDateInput').value = `${year}-${String(selectedDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        unselectTimeRadios();
    }

    const bookedSlots = {{ booked_slots|safe }};
    console.log(bookedSlots);

    function updateTimeSlots() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const selectedIsToday = selectedDate.getFullYear() === today.getFullYear() &&
            selectedDate.getMonth() === today.getMonth() &&
            selectedDate.getDate() === today.getDate();

        const now = new Date();

        document.querySelectorAll('input[name="time"]').forEach(input => {
            const label = input.closest('label');
            const timeStr = input.value;
            // แปลงเวลาเป็น Date object ของวันที่เลือก
            const [hour, minute] = timeStr.split(':');
            const slotDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), parseInt(hour), parseInt(minute), 0, 0);

            // สร้าง key สำหรับเช็ค slot ที่ถูกจองแล้ว
            const slotKey = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}-${String(selectedDate.getDate()).padStart(2,'0')}_${timeStr}`;

            let isDisabled = false;

            // เงื่อนไข 1: เวลาที่ผ่านมาแล้วในวันนี้
            if (selectedIsToday && slotDate <= now) {
                isDisabled = true;
            }

            // เงื่อนไข 2: slot นี้ถูกจองแล้ว
            if (bookedSlots.includes(slotKey)) {
                isDisabled = true;
            }

            if (isDisabled) {
                input.disabled = true;
                label.classList.remove('cursor-pointer');
                label.classList.add('cursor-not-allowed', 'border-red-400', 'border', 'rounded-lg', 'text-red-400');
            } else {
                input.disabled = false;
                label.classList.add('cursor-pointer');
                label.classList.remove('cursor-not-allowed', 'border-red-400', 'border', 'rounded-lg', 'text-red-400');
            }
        });
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        updateTimeSlots();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        updateTimeSlots();
    });

    selectedDate = new Date();
    renderCalendar();
    updateSelectedDateDisplay();
    updateTimeSlots();

    // อัปเดต time slot ทุกครั้งที่เลือกวันใหม่
    document.getElementById('calendarDays').addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
            updateTimeSlots();
        }
    });
</script>
{% endblock %}
